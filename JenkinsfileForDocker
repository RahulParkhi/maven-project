node{
    stage ('scm checkout')
	{
		git 'https://github.com/RahulParkhi/maven-project.git'
	}
	stage('Checkout to different branch')
	{
        sh "git branch -r"
        sh "git checkout ci-cd-with-docker"
    }
	stage ('create an application package')
	{
       sh label: '', script: 'mvn clean package '
    }
	stage ('docker image build')
	{
	   sh 'docker build -t rapsdock/my-app:1.0.0 .'
	
	}
	stage ('Push Docker image to DockerHub')
	{
		withCredentials([usernamePassword(credentialsId: 'Jenkins-to-DockerHub', passwordVariable: 'DockerHubPasswd', usernameVariable: 'DockerHubUser')])
		{
			sh "docker login -u ${DockerHubUser} -p ${DockerHubPasswd}"
		}
		sh 'docker push rapsdock/my-app:1.0.0'
	}
	
	stage ('Deploy to Dev')
	{
	   def dockerRun = 'docker run -d -p 9000:8080 --name my-tomcat-app rapsdock/my-app:1.0.0'
	   sshagent(['deploy-to-dev-docker'])
	   {
             sh "ssh -o StrictHostKeyChecking=no ec2-user@172.31.63.162 ${dockerRun}"
	   }
    }	
	
}
